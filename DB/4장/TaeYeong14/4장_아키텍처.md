### **CH 04. 아키텍처**

### **4.1 MySQL 엔진 아키텍처**

- **MySQL의 전체 구조**
    - MySQL 서버는 **MySQL 엔진**과 **스토리지 엔진**으로 구분된다
    - **MySQL 엔진**
        
        : 요청된 SQL 문장을 분석하거나 최적화한다
        
        - 커넥션 핸들러
            - 클라이언트로부터의 접속 및 쿼리 요청을 처리
        - SQL 파서
            - 요청의 의한 Query를 토큰으로 분리해 MySQL 이 인식할 수 있는 트리 형태의 구조로 만들고, 기본 문법 오류가 이 과정에서 발견됨
        - 전처리기
            - 파서 트리를 기반으로 쿼리 문장에 구조적인 문제점이 있는지 확인
        - 옵티마이저
            - Query를 얼마나 낮은 비용으로 효율적으로 처리할지 결정하는 역할 수행
            - Query 재작성, 스캔 순서 조정 및 인덱스의 선택같은 작업 수행
        
        - MySQL 엔진은 하나이다.
    - **스토리지 엔진**
        
        : 실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지로부터 데이터를 읽어온다
        
        - 스토리지 엔진은 여러 개를 동시에 사용할 수 있다
    - **핸들러 API**
        
        : MySQL 실행 엔진이 데이터를 읽거나 쓸 때 각 스토리지 엔진에 읽기 또는 쓰기를 요청하는 핸들러 요청에 사용되는 API
        

- **MySQL 스레딩 구조**
    - MySQL 서버는 **스레드 기반 구조**로 작동된다
    - **포그라운드 스레드(클라이언트 스레드)**
        
        : 주로 각 클라이언트 사용자가 요청하는 쿼리 문장을 처리한다
        
        - 최소 MySQL 서버에 접속된 클라이언트 수만큼 존재한다
        - 데이터를 MySQL의 데이터 버퍼나 캐시로부터 가져오고, 버퍼나 캐시에 없는 경우 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어와 작업을 처리한다
    - **백그라운드 스레드**
        
        : InnoDB 작업을 수행한다
        
        - 인서트 버퍼(Insert Buffer)를 병합하는 스레드
        - 로그를 디스크로 기록하는 스레드
        - InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드
        - 데이터를 버퍼로 읽어 오는 스레드
        - 잠금이나 데드락을 모니터링하는 스레드
        
        - 읽기 스레드는 클라이언트 스레드에서 처리되기에 많은 설정이 필요 없지만, 쓰기 스레드는 아주 많은 작업을 백그라운드에서 처리하기에 충분히 설정해야 한다

- **메모리 구조**
    - **글로벌 메모리 영역**
        - 클라이언트 스레드 수와 무관하게 메모리 공간을 할당 받는다.
        - 생성된 모든 글로벌 영역은 모든 스레드에 의해 공유된다.
        
        - 테이블 캐시
        - InnoDB 버퍼 풀
        - InnoDB 어댑티브 해시 인덱스
        - InnoDB 리두 로그 버퍼
    - **로컬 메모리 영역**
        - 세션 메모리 영역이라고도 하며, MySQL 클라이언트 스레드가 쿼리를 처리하는데 사용하는 메모리 영역이다
        - 각 클라리어트 스레드 별로 독립적으로 할당되며 절대 공유되지 않는다
        - 커넥션이 열려 있는 동안 계속 할당된 상태로 남아 있는 공간(커넥션 버퍼, 결과 버퍼)과 쿼리를 실행하는 순간에만 할당했다가 해제하는 공간(소트 버퍼, 조인 버퍼)이 있다
        - 대표적인 로컬 메모리 영역
            - 정렬 버퍼
            - 조인 버퍼
            - 바이너리 로그 캐시
            - 네트워크 버퍼

- **쿼리 실행 구조**
    - **쿼리 처리 단계**
        1. **쿼리 파서** : 사용자 요청으로 들어온 쿼리 문장을 토큰으로 분리해 트리 형태의 구조로 만들어 내는 작업이다
        2. **전처리기** : 파서 과정에서 만들어진 파서 트리를 기반으로 쿼리 문장의 문제점을 확인한다
        3. **옵티마이저** : 사용자의 요청으로 들어온 쿼리 문장의 효율적인 처리를 결정하는 역할을 맡으며, DBMS의 두뇌이다
        4. **실행 엔진** : 만들어진 계획대로 각 핸들러에게 요청해서 받은 결과를 또 다른 핸들러의 입입력으로 연결하는 역할을 수행한다
    - **핸들러** : MySQL 실행 엔진의 요청에 따라 데이터를 디스크에 저장하고 읽어오는 역할을 담당한다

- **플러그인 스토리지 엔진 모델**
    - MySQL 서버에 추가적인 기능을 제공하는 외부 소프트웨어 모듈을 로드할 수 있는 방법을 제공하는 아키텍처이다
    - MySQL 쿼리 실행 과정: SQL 파서 → 옵티마이저 → 실행기 → 데이터 읽기/쓰기 → 디스크
    - 대부분 작업은 MySQL 엔진이 처리, 데이터 읽기/쓰기는 **스토리지 엔진**이 담당한다
    - GROUP BY, ORDER BY 등은 **MySQL 엔진**에서 처리한다

- **쿼리 캐시**
    - 쿼리 캐시는 SQL 실행 결과를 메모리에 캐시하고 동일한 SQL 쿼리가 실행되면 테이블을 읽지 않고 즉시 결과를 반환하기 때문이 빠른 성능을 보여준다
    - 심각한 동시 처리 성능 저하 유발로 MySQL8.0 부터 삭제됐다

---

### **4.2 InnoDB 스토리지 엔진 아키텍처**

- **프라이머리 키 클러스터링**
    - 데이터를 프라이머리 키 순서로 저장한다
    - 세컨더리 인덱스는 프라이머리 키 값을 논리 주소로 사용한다
    - 클러스터링으로 빠른 레인지 스캔을 지원한다
- **MVCC(Multi-Version Concurrency Control)**
    - 언두 로그를 이용해 잠금 없이 데이터를 읽는다
    - 격리 수준에 따라 커밋되지 않은 데이터를 제외한다
- **Undo 로그**
    - 변경 전 데이터를 저장하여 트랜잭션 롤백 및 읽기 일관성을 유지한다
    - 트랜잭션 종료 시 삭제된다
- **버퍼 풀**
    - 디스크 데이터와 인덱스를 메모리에 캐싱하여 읽기/쓰기 성능을 향상시킨다
    - LRU 리스트를 통해 자주 사용되는 데이터를 메모리에 유지한다
- **Double Write Buffer**
    - 데이터 손상을 방지하기 위해 데이터를 두 번 기록한다
    - 파셜 페이지 문제를 해결한다
- **자동 데드락 감지**
    - InnoDB는 잠금 대기 그래프를 관리하여 데드락을 탐지한다
    - 언두 로그 양에 따라 롤백할 트랜잭션을 결정한다

---

### **4.3 MyISAM 스토리지 엔진 아키텍처**

- **키 캐시**
    - 인덱스 데이터를 메모리에 캐싱하여 성능을 최적화한다
- **데이터 파일 구조**
    - 데이터를 클러스터링 없이 저장하며 ROWID로 참조한다

---

### **4.4 MySQL 로그 파일**

- **에러 로그**
    - 서버에서 발생한 에러 및 경고 메시지를 기록한다
    - 서버 시작/종료, 비정상 종료 시 복구 메시지를 포함한다
- **제너럴 쿼리 로그**
    - 실행된 모든 쿼리를 기록한다
    - 쿼리 실행 중 에러 발생 시에도 기록된다
- **슬로우 쿼리 로그**
    - 설정된 시간 이상 소요된 쿼리를 기록하여 성능 문제를 식별한다
